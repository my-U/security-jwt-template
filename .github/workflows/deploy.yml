name: CI/CD Pipeline For Develop

on:
  push:
    branches:
      - main # master branch ì— push ê°€ ì„±ê³µì ìœ¼ë¡œ ë°œìƒí–ˆì„ ë•Œ ì•„ë˜ì˜ jobs ì„ ì‹¤í–‰

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7.0
        ports:
          - 6379:6379

    steps:
      - name: Checkout code  # GitHub repoì˜ ì½”ë“œë¥¼ ê°€ìƒë¨¸ì‹ ì— clone
        uses: actions/checkout@v4.1.7

      - name: Set up JDK 21  # JDK 21 ì„¤ì¹˜ (Corretto ë°°í¬íŒ)
        uses: actions/setup-java@v4.2.2
        with:
          java-version: '21'           # ğŸ”§ í•„ìš”ì— ë”°ë¼ JDK ë²„ì „ì„ ì¡°ì •í•˜ì„¸ìš”.
          distribution: 'corretto'     # ğŸ”§ ë‹¤ë¥¸ ë°°í¬íŒ(OpenJDK, temurin ë“±)ì„ ì‚¬ìš©í•  ê²½ìš° ìˆ˜ì •í•˜ì„¸ìš”.
          cache: gradle  # Gradle ì˜ì¡´ì„± ìºì‹œ ì¬ì‚¬ìš©ìœ¼ë¡œ ë¹Œë“œ ì†ë„ í–¥ìƒ

      - name: Create .env.common # .env.common ë³µì›
        run: echo "${{ secrets.ENV_COMMON_FILE }}" | base64 --decode > .env.common

      - name: Create .env.prod # .env.prod ë³µì›
        run: echo "${{ secrets.ENV_PROD_FILE }}" | base64 --decode > .env.prod

      - name: Create application-secret.yml # application-secret.yml ë³µì›
        run: echo "${{ secrets.SECRET_FILE }}" | base64 --decode > ./src/main/resources/application-secret.yml

      - name: Set executable permissions for gradlew  # í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‹¤í–‰ì„ ìœ„í•´ gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew

      - name: Wait for Redis to be ready  # Redis ì»¨í…Œì´ë„ˆê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸° (í…ŒìŠ¤íŠ¸ ì‹œ ì‚¬ìš©ë  ìˆ˜ ìˆìŒ)
        run: |
          timeout 30s bash -c 'until nc -z localhost 6379; do sleep 1; done' || {
            echo "Redis is not ready. Failing the build."; exit 1;
          }

      - name: Run tests  # í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‹¤í–‰
        run: ./gradlew test

      - name: Upload test results  # í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ (í•„ìˆ˜ëŠ” ì•„ë‹˜)
        if: always()
        uses: actions/upload-artifact@v4.4.3
        with:
          name: test-results
          path: build/reports/tests/test/

      - name: Set up Docker Buildx  # Docker Buildx ì„¤ì • (ë©€í‹° í”Œë«í¼ ë¹Œë“œ ì§€ì›)
        uses: docker/setup-buildx-action@v3.7.1

      - name: Log in to Docker Hub  # Docker Hub ë¡œê·¸ì¸ (ì´ë¯¸ì§€ pushë¥¼ ìœ„í•´ í•„ìš”)
        uses: docker/login-action@v3.3.0
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Build JAR  # Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ JAR ë¹Œë“œ
        run: ./gradlew bootJar

      - name: Build and Push Docker image  # ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° Docker Hubì— push
        uses: docker/build-push-action@v6.9.0
        with:
          context: .
          push: true
          tags: your-dockerhub-username/your-image-name:latest # ğŸ”§ Docker Hubì— ë§ê²Œ ì‚¬ìš©ìëª…ê³¼ ì´ë¯¸ì§€ëª…ì„ ìˆ˜ì •í•˜ì„¸ìš”.
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Slack ì•Œë¦¼ ê¸°ëŠ¥ ì‚¬ìš© ì‹œ ì£¼ì„ í•´ì œ
#      - name: Send Slack notification for build
#        if: always()
#        run: |
#          if [ "${{ job.status }}" == "success" ]; then
#            STATUS="âœ… Build succeeded!"
#            MESSAGE="$STATUS Commit: ${{ github.event.head_commit.message }} (ID: ${{ github.event.head_commit.id }})"
#          else
#            STATUS="âŒ Build failed!"
#            # ì—ëŸ¬ ë¡œê·¸ì—ì„œ ì‹¤íŒ¨ ìœ„ì¹˜ ì¤„ë§Œ ë½‘ê¸° (í´ë˜ìŠ¤, ì—ëŸ¬, ì˜ˆì™¸ í¬í•¨)
#            LOG=$(grep -iE "Exception|Error|at " docker-build.log | tail -n 10 | sed 's/"/\\"/g')
#            MESSAGE="$STATUS Commit: ${{ github.event.head_commit.message }} (ID: ${{ github.event.head_commit.id }})\n\`\`\`${LOG}\`\`\`"
#          fi
#
#          curl -X POST -H 'Content-type: application/json' \
#            --data "{\"text\": \"$MESSAGE\"}" \
#            ${{ secrets.SLACK_CICD_WEBHOOK }}

  deploy:
    needs: build  # build job ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰ë¨
    runs-on: ubuntu-latest

    steps:
      - name: SSH to Server and Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ~/your-project-directory # í”„ë¡œì íŠ¸ë³„ docker-compose.yml íŒŒì¼ì„ ë‹¤ìš´ ë°›ì„ ë””ë ‰í† ë¦¬ë¡œ ìˆ˜ì •í•˜ì„¸ìš”.
            
            # docker-compose.yml ë‹¤ìš´ë¡œë“œ
            curl -o docker-compose.yml https://raw.githubusercontent.com/your-username/your-repo-name/main/docker-compose.yml  # ğŸ”§ ì‚¬ìš©ìëª…, ë ˆí¬ëª…, ë¸Œëœì¹˜ëª…ì„ ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”.
            
            # .env íŒŒì¼ ë³µì›
            echo "${{ secrets.ENV_COMMON_FILE }}" | base64 --decode > .env.common
            echo "${{ secrets.ENV_PROD_FILE }}" | base64 --decode > .env.prod

            # .env íŒŒì¼ë¡œ í•©ì¹˜ê¸° - docker-compose.yml íŒŒì¼ì˜ ${VAR} í˜•ì‹ì€ .env íŒŒì¼ë§Œ ì¸ì‹í•˜ê¸° ë•Œë¬¸
            cat .env.prod .env.common > .env
            
            # ìµœì‹  ì´ë¯¸ì§€ pull + ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
            docker pull your-dockerhub-username/your-image-name:latest
            docker compose up -d

            # ì‚¬ìš©ë˜ì§€ ì•ŠëŠ”(dangling) ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f
            
            # .env íŒŒì¼ ì‚­ì œ
            rm .env .env.common .env.prod

      # Slack ì•Œë¦¼ ê¸°ëŠ¥ ì‚¬ìš© ì‹œ ì£¼ì„ í•´ì œ
#      - name: Notify Slack
#        if: always() # ì„±ê³µì´ë“  ì‹¤íŒ¨ë“  ë¬´ì¡°ê±´ ì‹¤í–‰
#        run: |
#          if [ "${{ job.status }}" == "success" ]; then
#            MESSAGE="âœ… Deploy succeeded!"
#          else
#            MESSAGE="âŒ Deploy failed!"
#          fi
#
#          curl -X POST -H 'Content-type: application/json' \
#          --data "{\"text\":\"$MESSAGE\"}" \
#          ${{ secrets.SLACK_CICD_WEBHOOK }}